<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://www.gstatic.com https://*.firebaseapp.com https://*.googleapis.com; script-src 'self' 'unsafe-inline' https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:;">
    <style>
        :root { --background-color: #ffffff; --text-color: #000000; }
        body { 
            background-color: var(--background-color); 
            color: var(--text-color); 
            font-family: 'Roboto Mono', monospace; 
            font-size: 16px; 
            line-height: 1.5; 
            margin: 0; 
            padding: 10vh 20px 20px 20px;
            box-sizing: border-box; 
        }
        .terminal-container { 
            width: 100%; 
            max-width: 800px; 
            margin: 0; 
        }
        h1 {
            font-size: 1em; 
            font-weight: normal; 
            margin-bottom: 1.5em;
            padding-bottom: 0.5em;
        }
        #messages-container { word-break: break-word; }
        .message { 
            margin-bottom: 1em; 
        }
        .message .timestamp { 
            display: block;
            margin-bottom: 0.3em;
            color: #a11d1d;
            font-size: 0.9em;
        }
        .error-message {
            color: #ff4141;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .loading {
            opacity: 0.7;
        }

        @media (min-width: 768px) {
            body {
                padding-left: 20vw;
            }
        }
    </style>
</head>
<body>
    <div class="terminal-container">
        <h1>Notas</h1>
        <div id="messages-container" class="loading">Cargando entradas...</div>
        <div id="connection-status" class="error-message" style="display: none;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, connectFirestoreEmulator } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCeQVpJTYM0UtRPmy4S8R38FYtl_b2ThzQ",
          authDomain: "mi-terminal-czt.firebaseapp.com",
          projectId: "mi-terminal-czt",
          storageBucket: "mi-terminal-czt.appspot.com",
          messagingSenderId: "979923860891",
          appId: "1:979923860891:web:56ae8c88bd65cea9a5b53e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const messagesContainer = document.getElementById('messages-container');
        const connectionStatus = document.getElementById('connection-status');

        // Función para sanitizar contenido HTML
        function sanitizeHTML(str) {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        // Función para validar y formatear timestamp
        function formatTimestamp(timestamp) {
            try {
                if (!timestamp || !timestamp.toDate) {
                    return '[Fecha inválida]';
                }
                const date = timestamp.toDate();
                if (isNaN(date.getTime())) {
                    return '[Fecha inválida]';
                }
                
                const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                const diaSemana = diasSemana[date.getDay()];
                
                const dia = date.getDate().toString().padStart(2, '0');
                const mes = (date.getMonth() + 1).toString().padStart(2, '0');
                const año = date.getFullYear();
                
                let horas = date.getHours();
                const minutos = date.getMinutes().toString().padStart(2, '0');
                const segundos = date.getSeconds().toString().padStart(2, '0');
                const periodo = horas >= 12 ? 'p.m.' : 'a.m.';
                
                if (horas > 12) {
                    horas -= 12;
                } else if (horas === 0) {
                    horas = 12;
                }
                
                const horasFormateadas = horas.toString().padStart(2, '0');
                
                return `[${diaSemana} ${dia}/${mes}/${año} ${horasFormateadas}:${minutos}:${segundos} ${periodo}]`;
            } catch (error) {
                console.error('Error al formatear timestamp:', error);
                return '[Fecha inválida]';
            }
        }

        // Función para mostrar mensaje de error de conexión
        function showConnectionError(message) {
            connectionStatus.textContent = `Error de conexión: ${message}`;
            connectionStatus.style.display = 'block';
        }

        function loadMessages() {
            try {
                const q = query(collection(db, "messages"), orderBy("createdAt", "desc"));
                
                const unsubscribe = onSnapshot(q, 
                    (querySnapshot) => {
                        try {
                            messagesContainer.classList.remove('loading');
                            messagesContainer.innerHTML = '';
                            connectionStatus.style.display = 'none';
                            
                            if (querySnapshot.empty) {
                                messagesContainer.textContent = "No hay entradas en el sistema.";
                                return;
                            }
                            
                            querySnapshot.forEach((doc) => {
                                try {
                                    const messageData = doc.data();
                                    
                                    // Validar que el documento tenga los campos requeridos
                                    if (!messageData.text || typeof messageData.text !== 'string') {
                                        console.warn('Documento con campo text inválido:', doc.id);
                                        return;
                                    }
                                    
                                    const messageElement = document.createElement('div');
                                    messageElement.classList.add('message');
                                    
                                    const formattedTimestamp = formatTimestamp(messageData.createdAt);
                                    const sanitizedText = sanitizeHTML(messageData.text);
                                    
                                    messageElement.innerHTML = `<span class="timestamp">${formattedTimestamp}</span><div class="text">${sanitizedText}</div>`;
                                    messagesContainer.appendChild(messageElement);
                                } catch (docError) {
                                    console.error('Error procesando documento:', docError);
                                }
                            });
                        } catch (snapshotError) {
                            console.error('Error procesando snapshot:', snapshotError);
                            showConnectionError('Error al cargar los mensajes');
                        }
                    },
                    (error) => {
                        console.error('Error en la conexión a Firestore:', error);
                        messagesContainer.classList.remove('loading');
                        showConnectionError('No se puede conectar a la base de datos');
                    }
                );

                // Cleanup function para cuando la página se descarga
                window.addEventListener('beforeunload', () => {
                    if (unsubscribe) {
                        unsubscribe();
                    }
                });

            } catch (error) {
                console.error('Error inicializando conexión:', error);
                showConnectionError('Error al inicializar la conexión');
                messagesContainer.classList.remove('loading');
            }
        }
        
        // Inicializar con manejo de errores
        try {
            loadMessages();
        } catch (error) {
            console.error('Error crítico al inicializar:', error);
            showConnectionError('Error crítico al inicializar la aplicación');
        }
    </script>
</body>
</html>
