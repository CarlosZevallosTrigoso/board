<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --background-color: #ffffff; --text-color: #000000; --cursor-color: #000000; }
        body { background-color: var(--background-color); color: var(--text-color); font-family: 'Roboto Mono', monospace; font-size: 16px; line-height: 1.5; margin: 0; padding: 20px; }
        .terminal-container { width: 100%; max-width: 800px; margin: 0 auto; }
        .hidden { display: none; }
        #user-prompt, #password-prompt { margin-right: 8px; }
        input[type="password"], input[type="text"] { background-color: transparent; border: none; color: var(--text-color); font-family: 'Roboto Mono', monospace; font-size: 16px; outline: none; padding: 0; width: 50%; }
        input:focus { animation: blink 1s step-end infinite; }
        @keyframes blink { from, to { border-right: 2px solid var(--cursor-color); } 50% { border-right: 2px solid transparent; } }
        #error-message { color: #ff4141; margin-top: 10px; height: 20px; }
        .prompt::before { content: '> '; margin-right: 8px; }
        .delete-btn { color: #ff4141; cursor: pointer; text-decoration: underline; margin-left: 15px; }
        .delete-btn.confirm-delete { font-weight: bold; }
        .message .timestamp { opacity: 0.7; }
    </style>
</head>
<body>
    <div class="terminal-container">
        <div id="board-section" class="hidden">
            <p>Bienvenido, czt. Escribe una nueva entrada o borra una existente.</p>
            <form id="post-form" class="prompt">
                <input type="text" id="message-input" autocomplete="off" placeholder="" maxlength="200">
            </form>
            <hr>
            <div id="admin-messages-container"></div>
        </div>
        <div id="login-section">
             <div id="user-prompt-container">
                <span id="user-prompt">login:</span>
                <input type="text" id="user-input" autocomplete="off" autofocus>
            </div>
            <div id="password-prompt-container" class="hidden">
                <span id="password-prompt">password:</span>
                <input type="password" id="password-input">
            </div>
            <div id="error-message"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Pega aquí tu configuración de Firebase
const firebaseConfig = {

  apiKey: "AIzaSyCeQVpJTYM0UtRPmy4S8R38FYtl_b2ThzQ",

  authDomain: "mi-terminal-czt.firebaseapp.com",

  projectId: "mi-terminal-czt",

  storageBucket: "mi-terminal-czt.firebasestorage.app",

  messagingSenderId: "979923860891",

  appId: "1:979923860891:web:56ae8c88bd65cea9a5b53e"

};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const loginSection = document.getElementById('login-section');
        const boardSection = document.getElementById('board-section');
        const userInput = document.getElementById('user-input');
        const passwordInput = document.getElementById('password-input');
        const userPromptContainer = document.getElementById('user-prompt-container');
        const passwordPromptContainer = document.getElementById('password-prompt-container');
        const errorMessage = document.getElementById('error-message');
        const postForm = document.getElementById('post-form');
        const messageInput = document.getElementById('message-input');
        const adminMessagesContainer = document.getElementById('admin-messages-container');

        const ACCESS_USER = "czt";
        const ACCESS_PASSWORD = "semeiotika2025!!";
        let enteredUsername = "";

        // --- Lógica de Login ---
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                enteredUsername = userInput.value;
                userPromptContainer.classList.add('hidden');
                passwordPromptContainer.classList.remove('hidden');
                passwordInput.focus();
            }
        });

        passwordInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (enteredUsername === ACCESS_USER && passwordInput.value === ACCESS_PASSWORD) {
                    loginSection.classList.add('hidden');
                    boardSection.classList.remove('hidden');
                    messageInput.focus();
                    loadAdminMessages();
                } else {
                    errorMessage.textContent = "Login incorrecto.";
                    passwordPromptContainer.classList.add('hidden');
                    passwordInput.value = "";
                    userPromptContainer.classList.remove('hidden');
                    userInput.value = "";
                    userInput.focus();
                    enteredUsername = "";
                }
            }
        });

        // --- Lógica para Postear ---
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            if (messageText.length > 0 && messageText.length <= 200) {
                try {
                    await addDoc(collection(db, "messages"), { text: messageText, createdAt: new Date() });
                    messageInput.value = '';
                } catch (error) {
                    console.error("Error al añadir documento: ", error);
                }
            }
        });

        // --- Cargar Mensajes para el Admin ---
        function loadAdminMessages() {
            const q = query(collection(db, "messages"), orderBy("createdAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                adminMessagesContainer.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const messageData = doc.data();
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message');
                    const date = messageData.createdAt.toDate();
                    const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                    const formattedTime = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    
                    messageElement.innerHTML = `
                        <span class="timestamp">[${formattedDate} ${formattedTime}]</span>
                        <span class="text">${messageData.text}</span>
                        <span class="delete-btn" data-id="${doc.id}">[borrar]</span>
                    `;
                    adminMessagesContainer.appendChild(messageElement);
                });
            });
        }

        // --- Lógica para Borrar con Confirmación ---
        adminMessagesContainer.addEventListener('click', async (e) => {
            const target = e.target;
            if (!target.classList.contains('delete-btn')) return;

            // Resetear otros botones que estén esperando confirmación
            const allButtons = adminMessagesContainer.querySelectorAll('.delete-btn.confirm-delete');
            allButtons.forEach(btn => {
                if (btn !== target) {
                    btn.classList.remove('confirm-delete');
                    btn.textContent = '[borrar]';
                }
            });

            // Si este botón ya está esperando, borrar
            if (target.classList.contains('confirm-delete')) {
                const id = target.dataset.id;
                try {
                    await deleteDoc(doc(db, "messages", id));
                } catch (error) {
                    console.error("Error al borrar el documento: ", error);
                    target.textContent = '[error]'; // Muestra error si falla
                }
            } else {
                // Primer clic, pedir confirmación
                target.classList.add('confirm-delete');
                target.textContent = '[confirmar borrado]';
            }
        });
    </script>
</body>
</html>
