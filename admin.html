<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --background-color: #ffffff; --text-color: #000000; }
        body { background-color: var(--background-color); color: var(--text-color); font-family: 'Roboto Mono', monospace; font-size: 16px; line-height: 1.5; margin: 0; padding: 0; }
        .terminal-container { width: 100%; max-width: 800px; margin-top: 10vh; margin-left: 10vw; }
        .hidden { display: none; }
        #email-prompt, #password-prompt { margin-right: 8px; }
        input[type="password"], input[type="text"] { background-color: transparent; border: none; color: var(--text-color); font-family: 'Roboto Mono', monospace; font-size: 16px; outline: none; padding: 0; width: 50%; }
        #error-message { color: #ff4141; margin-top: 10px; height: 20px; }
        .prompt::before { content: '> '; margin-right: 8px; }
        #reset-button { background-color: #ff4141; color: white; border: none; padding: 8px 15px; cursor: pointer; font-family: 'Roboto Mono', monospace; margin-top: 20px; }
        #reset-button.confirm { background-color: #cc0000; font-weight: bold; }
        #reset-status { margin-top: 10px; height: 20px; }
    </style>
</head>
<body>
    <div class="terminal-container">
        <div id="board-section" class="hidden">
            <p>Bienvenido. Escribe una nueva entrada y presiona Enter.</p>
            <form id="post-form" class="prompt">
                <input type="text" id="message-input" autocomplete="off" placeholder="" maxlength="200">
            </form>
            <div>
                <button id="reset-button">Reset (Borrar todo)</button>
                <p id="reset-status"></p>
            </div>
        </div>
        <div id="login-section">
             <div id="email-prompt-container">
                <span id="email-prompt">email:</span>
                <input type="text" id="email-input" autocomplete="off" autofocus>
            </div>
            <div id="password-prompt-container" class="hidden">
                <span id="password-prompt">password:</span>
                <input type="password" id="password-input">
            </div>
            <div id="error-message"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCeQVpJTYM0UtRPmy4S8R38FYtl_b2ThzQ",
          authDomain: "mi-terminal-czt.firebaseapp.com",
          projectId: "mi-terminal-czt",
          storageBucket: "mi-terminal-czt.appspot.com",
          messagingSenderId: "979923860891",
          appId: "1:979923860891:web:56ae8c88bd65cea9a5b53e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Elementos del DOM ---
        const loginSection = document.getElementById('login-section');
        const boardSection = document.getElementById('board-section');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const emailPromptContainer = document.getElementById('email-prompt-container');
        const passwordPromptContainer = document.getElementById('password-prompt-container');
        const errorMessage = document.getElementById('error-message');
        const postForm = document.getElementById('post-form');
        const messageInput = document.getElementById('message-input');
        const resetButton = document.getElementById('reset-button');
        const resetStatus = document.getElementById('reset-status');
        let enteredEmail = "";

        // --- Lógica de Login ---
        emailInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                enteredEmail = emailInput.value;
                emailPromptContainer.classList.add('hidden');
                passwordPromptContainer.classList.remove('hidden');
                passwordInput.focus();
            }
        });

        passwordInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                const password = passwordInput.value;
                
                signInWithEmailAndPassword(auth, enteredEmail, password)
                    .then((userCredential) => {
                        // Login exitoso
                        loginSection.classList.add('hidden');
                        boardSection.classList.remove('hidden');
                        messageInput.focus();
                    })
                    .catch((error) => {
                        // Login fallido
                        errorMessage.textContent = "Login incorrecto.";
                        passwordPromptContainer.classList.add('hidden');
                        passwordInput.value = "";
                        emailPromptContainer.classList.remove('hidden');
                        emailInput.value = "";
                        emailInput.focus();
                        enteredEmail = "";
                    });
            }
        });

        // --- Lógica para Postear ---
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            if (messageText.length > 0 && messageText.length <= 200) {
                try {
                    await addDoc(collection(db, "messages"), { text: messageText, createdAt: new Date() });
                    messageInput.value = '';
                } catch (error) {
                    console.error("Error al añadir documento: ", error);
                }
            }
        });

        // --- Lógica para Borrar Todo ---
        resetButton.addEventListener('click', async () => {
            if (resetButton.classList.contains('confirm')) {
                resetStatus.textContent = "Borrando...";
                try {
                    const messagesCollection = collection(db, "messages");
                    const querySnapshot = await getDocs(messagesCollection);
                    const deletePromises = [];
                    querySnapshot.forEach((doc) => {
                        deletePromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletePromises);
                    resetStatus.textContent = "Todos los mensajes han sido borrados.";
                } catch (error) {
                    console.error("Error al borrar todo: ", error);
                    resetStatus.textContent = "Error al borrar.";
                } finally {
                    resetButton.classList.remove('confirm');
                    resetButton.textContent = 'Reset (Borrar todo)';
                }
            } else {
                resetButton.classList.add('confirm');
                resetButton.textContent = 'Confirmar Borrado';
                resetStatus.textContent = "¿Estás seguro?";
            }
        });
    </script>
</body>
</html>
